<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<!-- <title>Load data from an external GeoJSON file</title> -->
<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
<link href="https://api.mapbox.com/mapbox-gl-js/v2.10.0/mapbox-gl.css" rel="stylesheet">
<script src="https://api.mapbox.com/mapbox-gl-js/v2.10.0/mapbox-gl.js"></script>
<script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>

<script src="./getColor.js"></script>
<script src="./margins.js"></script>

<style>
body { margin: 0; padding: 0; }
#map { position: absolute; top: 0; bottom: 0; width: 100%; }
</style>
</head>
<body>
<div id="map"></div>

<script>
    // https://mapshaper.org/
    // cat originalData.geojson | simplify-geojson -t 0.005 > data.geojson


    mapboxgl.accessToken = 'pk.eyJ1Ijoic3RlZXBhdHRpY3N0YWlycyIsImEiOiJjbDNvaGFod2EwbXluM2pwZTJiMDYzYjh5In0.J_HeH00ry0tbLmGmTy4z5w';
    const map = new mapboxgl.Map({
        container: 'map',
        // https://ovrdc.github.io/gis-tutorials/mapbox/02-adding-layers/
        style: {
            "version": 8,
            "name": "blank",
            "sources": {
                "openmaptiles": {
                    "type": "vector",
                    "url": ""
                }
            },
            "layers": [{
                "id": "background",
                "type": "background",
                "paint": {
                    "background-color": "#1d1f20"
                }
            }]
        },
        zoom: 3,
        center: [-98.5606744, 36.8281576],
    });

    // var marginObj = {};
    // $.getJSON('./data/data.geojson', function(data) {
    //     for (var item in data.features) {
    //         var district = data.features[item].properties.DISTRICT;
    //         var state = data.features[item].properties.STATE;
    //         var margin = data.features[item].properties.Color;
    // 
    //         if (!Number.isNaN(parseInt(district))) {
    //             district = parseInt(district);
    //         }
    // 
    //         marginObj[`${state}-${district}`] = margin;
    //     }
    //     console.log(marginObj)
    // })

    //console.clear();
    var startTimer = Date.now();
    map.on('load', () => {
        console.log(`Map loaded in ${Date.now() - startTimer} ms`);
        $.getJSON('./data/data.geojson', function(data) {
            for (var item in data.features) {
                var base = data.features[item].properties;
                var district = base.DISTRICT;
                var state = base.STATE;
                if (!Number.isNaN(parseInt(district))) {
                    district = parseInt(district);
                }
                var margin = margins[`${state}-${district}`];
                base.color = getColor(base.Color);
            }

            console.log(`Data fetched in ${Date.now() - startTimer} ms`);
            map.addSource('geojsonSource', {
                type: 'geojson',
                data: data
            });

            map.addLayer({
                'id': 'districtsLayer',
                'type': 'fill',
                'source': 'geojsonSource',
                paint: {
                    //#0080ff blue
                    //#ff7d7d red
                    'fill-color': ['get', 'color'],
                    'fill-opacity': 1
                }
            });
            // map.addLayer({
            //     'id': 'districtsLayerOutline',
            //     'type': 'line',
            //     'source': 'geojsonSource',
            //     'paint': {
            //         //#014385 blue
            //         //#850101 red
            //         'line-color': ['get', 'color'],
            //         'line-width': 3
            //     }
            // });
            function sourceCallback() {
                if (map.getSource('geojsonSource') && map.isSourceLoaded('geojsonSource')) {
                    console.log(`Map layer loaded in ${Date.now() - startTimer} ms`);
                    map.off('sourcedata', sourceCallback);
                }
            }
            map.on('sourcedata', sourceCallback);

            map.on('click', 'districtsLayer', (e) => {
                console.log(e.features[0])
                var district = e.features[0].properties.DISTRICT; // '6'
                var state = e.features[0].properties.STATE; // 'VA'
                //var margin = e.features[0].properties.Margin; // 0.29
                if (!Number.isNaN(parseInt(district))) {
                    district = parseInt(district);
                }
                var margin = margins[`${state}-${district}`];

                var popupContent =
                `<div>
                    <div><b>State:</b> ${state}</div>
                    <div><b>District:</b> ${district}</div>
                    <div><b>Margin:</b> ${margin}</div>
                </div>`

                var pop = new mapboxgl.Popup()
                    .setLngLat(e.lngLat)
                    .setHTML(popupContent)
                    //.setHTML(e.features[0].properties.description)
                    .addTo(map);
            })
        })
    });
</script>

</body>
</html>