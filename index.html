<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<!-- <title>Load data from an external GeoJSON file</title> -->
<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
<link href="https://api.mapbox.com/mapbox-gl-js/v2.10.0/mapbox-gl.css" rel="stylesheet">
<script src="https://api.mapbox.com/mapbox-gl-js/v2.10.0/mapbox-gl.js"></script>
<script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
<link href='https://fonts.googleapis.com/css?family=Abel' rel='stylesheet'>


<link href='./resources/bootstrap4c-custom-switch.css' rel='stylesheet'>

<script src="./getColor.js"></script>
<script src="./checkMobileBrowser.js"></script>
<script src="./margins.js"></script>

<style>
body {
    margin: 0;
    padding: 0;
}
#map {
    position: absolute;
    top: 0;
    bottom: 0;
    width: 100%;
}
#clickDialog {
    position: absolute;
    top: 0;
    bottom: 0;
    width: 100%;
    z-index: 1000;

    color: white;
    background-color: rgba(0, 0, 0, .5);
    backdrop-filter: blur(5px);

    display: flex;
    justify-content: center;
    align-items: center;
    cursor: pointer;

    font-family: 'Abel';
    font-size: 25px;
}
</style>
</head>
<body>
<div id="map"></div>
<div id="clickDialog">Click to enable the map.</div>

<!-- <div>
    <div class="custom-switch custom-switch-label-onoff">
        <input class="custom-switch-input" id="binaryColorToggle" type="checkbox">
        <label class="custom-switch-btn" for="binaryColorToggle"></label>
    </div>
</div> -->

<script>
    // https://mapshaper.org/
    // cat originalData.geojson | simplify-geojson -t 0.005 > data.geojson

    const isMobileBrowser = checkBrowser(); // true if the user is on mobile, false if on desktop / non-mobile

    $('#clickDialog').on('click', function() {
        $(this).hide();
    })
    if (!isMobileBrowser) {
        $('#map').on('mouseleave', function() {
            $("#clickDialog").fadeIn(500); 
        })
    } else {
        // because this will be in an iframe
        $(window.parent.document).on('click', function() {
            $("#clickDialog").fadeIn(500); 
        })
    }


    mapboxgl.accessToken = 'pk.eyJ1Ijoic3RlZXBhdHRpY3N0YWlycyIsImEiOiJjbDNvaGFod2EwbXluM2pwZTJiMDYzYjh5In0.J_HeH00ry0tbLmGmTy4z5w';
    const map = new mapboxgl.Map({
        container: 'map',
        // https://ovrdc.github.io/gis-tutorials/mapbox/02-adding-layers/
        style: {
            "version": 8,
            "name": "blank",
            "sources": {
                "openmaptiles": {
                    "type": "vector",
                    "url": ""
                }
            },
            "layers": [{
                "id": "background",
                "type": "background",
                "paint": {
                    "background-color": "#1d1f20"
                }
            }]
        },
        zoom: 3.5,
        minZoom: 2,
        maxZoom: 10,
        center: [-97.06912403055196, 37.718324457777555],
    });
    if (isMobileBrowser) { map.setZoom(2.5); }

    // map.on('move', function() {
    //     console.log(map.getCenter())
    // })

    // var marginObj = {};
    // $.getJSON('./data/data.geojson', function(data) {
    //     for (var item in data.features) {
    //         var district = data.features[item].properties.DISTRICT;
    //         var state = data.features[item].properties.STATE;
    //         var margin = data.features[item].properties.Color;
    // 
    //         if (!Number.isNaN(parseInt(district))) {
    //             district = parseInt(district);
    //         }
    // 
    //         marginObj[`${state}-${district}`] = margin;
    //     }
    //     console.log(marginObj)
    // })

    //console.clear();
    var startTimer = Date.now();
    map.on('load', () => {
        console.log(`Map loaded in ${Date.now() - startTimer} ms`);
        $.getJSON('./data/data.geojson', function(data) {
            for (var item in data.features) {
                var base = data.features[item].properties;
                var district = base.DISTRICT;
                var state = base.STATE;
                if (!Number.isNaN(parseInt(district))) {
                    district = parseInt(district);
                }
                var margin = margins[`${state}-${district}`];
                base.color = getColor(margin);
            }

            console.log(`Data fetched in ${Date.now() - startTimer} ms`);
            map.addSource('geojsonSource', {
                type: 'geojson',
                data: data
            });

            map.addLayer({
                'id': 'districtsLayer',
                'type': 'fill',
                'source': 'geojsonSource',
                paint: {
                    //#0080ff blue
                    //#ff7d7d red
                    'fill-color': ['get', 'color'],
                    'fill-opacity': 1
                }
            });
            map.addLayer({
                'id': 'districtsLayerOutline',
                'type': 'line',
                'source': 'geojsonSource',
                'paint': {
                    //#014385 blue
                    //#850101 red
                    'line-color': 'black',
                    'line-width': 1.5
                }
            });
            function sourceCallback() {
                if (map.getSource('geojsonSource') && map.isSourceLoaded('geojsonSource')) {
                    console.log(`Map layer loaded in ${Date.now() - startTimer} ms`);
                    map.off('sourcedata', sourceCallback);
                }
            }
            map.on('sourcedata', sourceCallback);

            function isNegative(num) {
                if (Math.sign(num) === -1) {
                    return true;
                }
                return false;
            }

            map.on('click', 'districtsLayer', (e) => {
                console.log(e.features[0])
                var district = e.features[0].properties.DISTRICT; // '6'
                var state = e.features[0].properties.STATE; // 'VA'
                //var margin = e.features[0].properties.Margin; // 0.29
                if (!Number.isNaN(parseInt(district))) {
                    district = parseInt(district);
                }
                var margin = margins[`${state}-${district}`];

                var marginFormatted = `${Math.round(Math.abs(margin)*100)}%`
                if (isNegative(margin)) {
                    marginFormatted = `D+${marginFormatted}`
                } else {
                    marginFormatted = `R+${marginFormatted}`
                }
                // e.g. R+39%

                var popupContent =
                `<div>
                    <div><b>State:</b> ${state}</div>
                    <div><b>District:</b> ${district}</div>
                    <div><b>Margin:</b> ${marginFormatted}</div>
                </div>`

                var pop = new mapboxgl.Popup()
                    .setLngLat(e.lngLat)
                    .setHTML(popupContent)
                    //.setHTML(e.features[0].properties.description)
                    .addTo(map);
            })
        })
    });
</script>

</body>
</html>